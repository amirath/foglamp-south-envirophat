#!/bin/sh

##--------------------------------------------------------------------
## Copyright (c) 2018 OSIsoft, LLC
##
## Licensed under the Apache License, Version 2.0 (the "License");
## you may not use this file except in compliance with the License.
## You may obtain a copy of the License at
##
##     http://www.apache.org/licenses/LICENSE-2.0
##
## Unless required by applicable law or agreed to in writing, software
## distributed under the License is distributed on an "AS IS" BASIS,
## WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
## See the License for the specific language governing permissions and
## limitations under the License.
##--------------------------------------------------------------------

##--------------------------------------------------------------------
##
## @postinst DEBIAN/postinst
## This script is used to execute post installation tasks.
##
## Author: Ivan Zoratti
##
##--------------------------------------------------------------------

set -e

sudo -u postgres psql -d foglamp -q -t << '___SQL___'
INSERT INTO foglamp.configuration ( key, description, value )
     VALUES ( 'ENVIROPHAT',
              'Enviro pHAT Polling South Plugin',
              ' { "plugin" : { "type" : "string", "value" : "envirophat", "default" : "envirophat", "description" : "Python module name of the plugin to load" } } ' );

INSERT INTO foglamp.scheduled_processes ( name, script ) VALUES ( 'ENVIROPHAT', '["services/south"]' );

--- Add the schedule to start the service at system startup
INSERT INTO foglamp.schedules ( id, schedule_name, process_name, schedule_type, schedule_time, schedule_interval, exclusive, enabled )
     VALUES ( '4e82840c-34c0-4b0b-8ce2-9ae4ae83162b', -- id
              'ENVHAT poll south',                    -- schedule_name
              'ENVIROPHAT',                           -- proceess_name
              1,                                      -- schedule_type (startup)
              NULL,                                   -- schedule_time
              '00:00:00',                             -- schedule_interval
              true,                                   -- exclusive
              true                                    -- enabled
            );
___SQL___

